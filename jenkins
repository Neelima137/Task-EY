pipeline {
  agent any

  environment {
    PROJECT_ID = 'cts07-devadin'
    CLUSTER_NAME = 'ey-test-cluster'
    CLUSTER_ZONE = 'us-central1-a' 
  }

  stages {
    stage('Clone Repository') {
      steps {
        git branch: 'main', url: 'https://github.com/Neelima137/Task-EY.git'
      }
    }
  stage('Setup GKE Tools') {
    steps {
        sh '''
            echo "Installing kubectl and gke-gcloud-auth-plugin..."

            # Install kubectl (latest stable)
            curl -LO "https://dl.k8s.io/release/$(curl -sL https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
            chmod +x kubectl
            mv kubectl /usr/local/bin/ 2>/dev/null || export PATH=$PATH:$(pwd)

            # Install gke-gcloud-auth-plugin via gcloud (guaranteed compatible)
            echo "Installing static GKE gcloud auth plugin..."
            curl -sLo gke-gcloud-auth-plugin https://github.com/GoogleCloudPlatform/cloud-sdk-go/releases/download/v0.1.0/gke-gcloud-auth-plugin_linux_x86_64
            chmod +x gke-gcloud-auth-plugin
            mv gke-gcloud-auth-plugin /usr/local/bin/ 2>/dev/null || export PATH=$PATH:$(pwd)

            echo "Installation complete"
            kubectl version --client
            gke-gcloud-auth-plugin --version || echo "Plugin installed via gcloud components"
        '''
    }
}


    stage('Authenticate to GKE') {
      steps {
        withCredentials([file(credentialsId: 'gcp-service-key', variable: 'GOOGLE_APPLICATION_CREDENTIALS')]) {
        sh '''
          echo "Authenticating to GCP..."
          gcloud auth activate-service-account --key-file=$GOOGLE_APPLICATION_CREDENTIALS
          gcloud config set project $PROJECT_ID
          gcloud container clusters get-credentials $CLUSTER_NAME --zone $CLUSTER_ZONE --project $PROJECT_ID
        '''
      }
    }
}

    stage('Deploy Blue (Current Version)') {
      steps {
        sh 'echo "Deploying BLUE version..."'
        sh 'kubectl apply -f k8s/deployment-nginx-1.28.0.yaml'
        sh 'kubectl apply -f k8s/common-service.yaml'
      }
    }

    stage('Deploy Green (New Version)') {
      steps {
        sh 'echo "Deploying GREEN version..."'
        sh 'kubectl apply -f k8s/deployment-nginx-1.29.3.yaml'
        sh 'echo "Testing GREEN deployment..."'
        sh 'kubectl get pods -l version=green'
      }
    }

    stage('Switch Traffic to Green') {
      steps {
        input message: "Switch traffic to GREEN?"
        sh '''
          echo "Switching Service selector to GREEN..."
          kubectl patch service nginx-service -p '{"spec":{"selector":{"version":"green"}}}'
        '''
      }
    }

    stage('Clean Up Old Blue Pods') {
      steps {
        sh 'echo "Deleting old BLUE deployment..."'
        sh 'kubectl delete deployment nginx-blue || true'
      }
    }
  }
}
