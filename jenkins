pipeline {
  agent any

  environment {
    PROJECT_ID = 'cts07-devadin'
    CLUSTER_NAME = 'ey-test-cluster'
    CLUSTER_ZONE = 'us-central1-a' 
  }

  stages {
    stage('Clone Repository') {
      steps {
        git branch: 'main', url: 'https://github.com/Neelima137/Task-EY.git'
      }
    }

    stage('Authenticate to GKE') {
      steps {
        withCredentials([file(credentialsId: 'gcp-service-key', variable: 'GOOGLE_APPLICATION_CREDENTIALS')]) {
        sh '''
          echo "Authenticating to GCP..."
          gcloud auth activate-service-account --key-file=$GOOGLE_APPLICATION_CREDENTIALS
          gcloud config set project $PROJECT_ID
          gcloud container clusters get-credentials $CLUSTER_NAME --zone $CLUSTER_ZONE --project $PROJECT_ID
        '''
      }
    }
}
  stage('cleanup') {
      steps {
        sh 'echo "deleting the deployments..."'
        sh 'kubectl delete deployment nginx-deployment-blue -n default  --ignore-not-found'
        sh 'kubectl delete deployment nginx-deployment-green -n default  --ignore-not-found'
        
      }
    }

    stage('Deploy Blue (Current Version)') {
      steps {
        sh 'echo "Deploying BLUE version..."'
        sh 'kubectl apply -f deployment-nginx-1.28.0.yaml -n default '
        sh 'kubectl apply -f common-service.yaml -n default '
      }
    }

    stage('Deploy Green (New Version)') {
      steps {
        sh 'echo "Deploying GREEN version..."'
        sh 'kubectl apply -f deployment-nginix-1.29.3.yaml -n default '
        sh 'echo "Testing GREEN deployment..."'
        sh 'kubectl get pods -l version=green -n default '
      }
    }


stage('Approval satge: Switch or Abort') {
      steps {
        script {
          def userInput = input(
            id: 'ProceedOrAbort', message: 'Do you want to switch traffic to GREEN?',
            parameters: [choice(name: 'ACTION', choices: 'Approve\nAbort', description: 'Select action')]
          )

          if (userInput == 'Approve') {
            echo " Approved - Switching traffic to GREEN..."
            sh '''
              kubectl patch service nginx-service -n $NAMESPACE -p '{"spec":{"selector":{"app":"nginx","version":"green"}}}'
              kubectl delete deployment nginx-deployment-blue -n default --ignore-not-found
              echo "Switched to GREEN and deleted BLUE deployment."
            '''
          } else {
            echo " Aborted - Keeping BLUE and deleting GREEN deployment..."
            sh '''
              kubectl delete deployment nginx-deployment-green -n default --ignore-not-found
              echo "Reverted to BLUE deployment."
            '''
          }
        }
      }
    }
  }
}

//    stage('Switch Traffic to Green') {
      steps {
        input message: "Switch traffic to GREEN?"
        sh '''
          echo "Switching Service selector to GREEN..."
          kubectl patch service nginx-service -n default -p '{"spec":{"selector":{"app":"nginx","version":"green"}}}'
        '''  
      }
    }

    stage('Clean Up Old Blue Pods') {
      steps {
        sh 'echo "Deleting old BLUE deployment..."'
        sh 'kubectl delete deployment nginx-deployment-blue -n default t --ignore-not-found'
      }
    }
  }
}
//
